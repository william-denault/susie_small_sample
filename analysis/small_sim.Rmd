---
title: A few small simulations to assess benefits of NIG prior in various settings
author: Peter Carbonetto
output: workflowr::wflow_html
---

ADD TEXT HERE

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages needed to perform the analyses below.

```{r load-pkgs, message=FALSE}
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility:

```{r set-seed}
set.seed(1)
```

ADD TEXT HERE.

```{r load-output-n-500}
load("../output/small_sim_out_n=500_v0.14.47.RData")
```

This is a function I will use to empirically assess power and coverage
from the simulations.

```{r define-compute-power-and-coverage}
compute_power_and_coverage <- function (res, causal) {
  N        <- length(res)
  power    <- 0
  coverage <- 0
  V_true  <- NULL
  V_false <- NULL
  for (i in 1:N) {
    V        <- res[[i]]$V
	cs       <- res[[i]]$sets$cs
	L        <- length(V)
	all_cs   <- paste0("L",seq(1,L))
    names(V) <- all_cs
    if (length(cs) == 0) {
      x <- NULL
	  y <- NULL
    } else {
      x <- intersect(unique(unlist(cs)),causal[[i]])
	  y <- names(which(sapply(cs, 
             function (x) length(intersect(causal_snps[[i]],x)) > 0)))
    }
    V_true   <- c(V_true,V[y])
    V_false  <- c(V_false,V[setdiff(all_cs,y)])
    power    <- power     + length(x)
	coverage <- coverage + length(y)
  }
  num_true <- sum(sapply(causal,length))
  num_pos  <- sum(sapply(res,function (x) length(x$sets$cs)))
  return(list(power    = power/num_true,
              coverage = coverage/num_pos,
              V_true   = V_true,
			  V_false  = V_false))
}
```

And this a function I will use to compute the sizes of the credible
sets:

```{r define-get-cs-sizes}
get_cs_sizes <- function (res)
  unlist(lapply(res,function (x) sapply(x$sets$cs,length)))
```

Compare power and coverage:

```{r power-coverage-n-500}
stats_susie    <- compute_power_and_coverage(res_susie,causal_snps)
stats_susie_ss <- compute_power_and_coverage(res_susie_small,causal_snps)
data.frame(method   = c("susie","susie_ss"),
           power    = c(stats_susie$power,stats_susie_ss$power),
  	       coverage = c(stats_susie$coverage,stats_susie_ss$coverage))
```

These are the running times:

```{r runtimes-n-500}
summary(runtimes)
```

Compare the prior variances of the true positives vs. the false positives:

```{r V-n-500, fig.height=2, fig.width=4.25}
pdat <- rbind(data.frame(method = "susie",causal = TRUE,
                         V = stats_susie$V_true),
              data.frame(method = "susie",causal = FALSE,
			             V = stats_susie$V_false),
              data.frame(method = "susie_ss",causal = TRUE,
			             V = stats_susie_ss$V_true),
              data.frame(method = "susie_ss",causal = FALSE,
			             V = stats_susie_ss$V_false))
pdat <- transform(pdat,sigma = sqrt(V))
pdat <- subset(pdat,sigma < 2)
ggplot(pdat,aes(x = sigma,color = causal,fill = causal)) +
  facet_grid(cols = vars(method),scales = "free_y",axes = "all") +
  geom_histogram(bins = 24,position = "stack",linewidth = 0.05) +
  scale_color_manual(values = c("darkblue","orangered")) +
  scale_fill_manual(values = c("darkblue","orangered")) +
  ylim(0,50) +
  labs(x = "prior s.d.") +
  theme_cowplot(font_size = 10)
```

Now compare in the setting with much fewer samples:

```{r load-output-n-40}
load("../output/small_sim_out_n=40_v0.14.47.RData")
```

Compare power and coverage:

```{r power-coverage-n-40}
stats_susie    <- compute_power_and_coverage(res_susie,causal_snps)
stats_susie_ss <- compute_power_and_coverage(res_susie_small,causal_snps)
data.frame(method   = c("susie","susie_ss"),
           power    = c(stats_susie$power,stats_susie_ss$power),
  	       coverage = c(stats_susie$coverage,stats_susie_ss$coverage))
```

These are the running times:

```{r runtimes-n-40}
summary(runtimes)
```

Compare the prior variances of the true positives vs. the false positives:

```{r V-n-40, fig.height=2, fig.width=4.25}
pdat <- rbind(data.frame(method = "susie",causal = TRUE,
                         V = stats_susie$V_true),
              data.frame(method = "susie",causal = FALSE,
			             V = stats_susie$V_false),
              data.frame(method = "susie_ss",causal = TRUE,
			             V = stats_susie_ss$V_true),
              data.frame(method = "susie_ss",causal = FALSE,
			             V = stats_susie_ss$V_false))
pdat <- transform(pdat,sigma = sqrt(V))
pdat <- subset(pdat,sigma < 2)
ggplot(pdat,aes(x = sigma,color = causal,fill = causal)) +
  facet_grid(cols = vars(method),scales = "free_y",axes = "all") +
  geom_histogram(bins = 24,position = "stack",linewidth = 0.05) +
  scale_color_manual(values = c("darkblue","orangered")) +
  scale_fill_manual(values = c("darkblue","orangered")) +
  ylim(0,60) +
  labs(x = "prior s.d.") +
  theme_cowplot(font_size = 10)
```
